<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Bluetooth description</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="$relpath/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="$relpath/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<table><tr><td><img class="header" src="LEGO.jpg"></td><td><h1>&nbsp;&nbsp;&nbsp;LEGO Mindstorms EV3</h1></td></tr></table><hr size="1"/>
<!-- Generated by Doxygen 1.8.7 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="index.html">Firmware Documentation</a></li><li class="navelem"><a class="el" href="implementation.html">Implementation</a></li><li class="navelem"><a class="el" href="CommunicationLibrary.html">Communication Library</a></li><li class="navelem"><a class="el" href="CommunicationLibraryDescription.html">Description</a></li><li class="navelem"><a class="el" href="BluetoothPart.html">Bluetooth</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Bluetooth description </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><hr/>
<pre class="fragment"> Support of up to 7 connection - either 7 outgoing or 1 incoming connection.

 Scatter-net is not supported. If connected from outside (by bluetooth) then
 the  connection is closed if an outgoing connection is made from the brick.

 Pin agent is used to handle pairing.

 DBUS is used to handle connection creation.

 Sockets are used to communicate with the remote devices.


 Bluetooth buffer setup
 ----------------------

 RX side:

 Bluetooth socket
      |
       --&gt; c_bt RxBuf - Fragmented async. data bytes
               |
                --&gt; c_bt Msg buffer  - Collected as complete LEGO protocol messages
                           |
                            --&gt; c_com rx buffer - Transferred to c_com level for interpretation


 Tx side:

 c_com tx buffer
       |
        --&gt; c_bt WriteBuf Buffer
                    |
                     --&gt;  Bluetooth socket





 In mode2:
 ---------

 RX:

 Bluetooth socket
       |
        --&gt; Mode2Buf - Fragmented data bytes (c_bt.c)
                |
                 --&gt; Mode2InBuf - Fragmented data bytes (c_i2c.c)
                          |
                           --&gt; Transfer to Mode2 decoding
                                  |
                                   --&gt; READBUF (return bytes from mode2 decoding) -&gt; for mode1 decoding
                                  |
                                  |
                                   --&gt; WriteBuf (return bytes from mode2 decoding) -&gt; for tx to remote mode2 device


 TX:

 Mode2WriteBuf   (c_bt.c)
     |
      --&gt; Transfer to mode2 decoding  (data read in c_i2c.c)
             |
              --&gt; WriteBuf (return bytes from mode2 decoding) -&gt; for tx  (c_bt.c)
                                          |
                                           --&gt;  Bluetooth socket



 CONNECTION MANAGEMENT
 ---------------------


   CONNECTING:

   Connecting brick:                                        Remote brick:

   Connect to brick (Issued from byte codes)     |
   - Set busy flag                               |
   - Disable page inquiry                        |
   - Open socket                           ---&gt;  |  ---&gt;    EVT_CONN_REQUEST
                                                 |          - Issue remote name request
                                                 |
   Optional pin/passkey exchange (agent)   &lt;--&gt;  |  &lt;--&gt;    optional pin/passkey exchange (agent)
                                                 |
   EVT_CONN_COMPLETE                       &lt;---  |  ---&gt;    EVT_CONN_COMPLETE
   - Disable page inquiry                        |          - Disable page inquiry        (Cannot be connected to more than one, as a slave)
   - Update Device list                          |          - Insert all info in dev list (Except connected)
   - Update Search list                          |
                                                 |
   Socket write ready (Remote socket open) &lt;---  |  ---&gt;    Success on accept listen socket (Socket gives remote address)
   - NoOfConnDevices++                           |          - Set slave mode
   - Update Search list to connected             |          - NoOfConnDevices++
   - Update Device list to connected             |          - Update Device list to connected
                                                 |          - Update Search list to connected
                                                 |


   DISCONNECTING:

   Disconnecting brick:                          |          Remote brick:
                                                 |
   Disconnect  (Issued from byte codes)          |
   - Close bluetooth socket                ---&gt;  |  ---&gt;    Socket indicates remote socket closed
                                                 |          - Close socket
                                                 |
                                                 |
   EVT_DISCONN_COMPLETE                    &lt;---  |  ---&gt;    EVT_DISCONN_COMPLETE
   - Update Search list to disconnected          |          - Update Search list to disconnected
   - Update Device list to disconnected          |          - Update Device list to disconnected
   - NoofConnDevices--                           |          - NoofConnDevices--
   - If NoofConnDevices = 0 -&gt; set idle mode     |          - If NoofConnDevices = 0 -&gt; set idle mode</pre> </div></div><!-- contents -->
<hr size="1"/><address style="text-align: center;">
LEGO&reg Robotics Firmware Documentation<br/>Confidential Information &copy 2013 The LEGO Group</address>
</body>
</html>
